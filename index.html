<!-- index.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Perguntas de teste</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="question-box" id="questionBox">
    <div id="questionText">Carregando...</div>
    <ul class="options" id="optionsList"></ul>
    <div class="feedback" id="feedback"></div>
    <button id="nextButton">Pr√≥xima pergunta</button>
    <div class="score" id="scoreBox"></div>
  </div>

  <a href="como-funciona.html" id="howItWorksLink">‚ÑπÔ∏è Como funciona o quiz?</a>
  <button id="clearProgress">üóëÔ∏è Limpar progresso</button>

  <script>
    const STORAGE_KEY = "quiz_progress";
    const SCORE_KEY = "quiz_score";
    const WRONG_KEY = "quiz_wrong";

    let questions = [];
    let usedIndexes = new Set();
    let currentQuestion = null;
    let score = 0;
    let wrongAnswers = [];
    let answered = false;

    function loadQuestions() {
      fetch("questions.md")
        .then(res => res.text())
        .then(text => {
          questions = parseMarkdownQuestions(text);
          showScore();
          showRandomQuestion();
        });
    }

    function parseMarkdownQuestions(text) {
      const blocks = text.split(/^### /gm).slice(1);
      return blocks.map(block => {
        const [qLine, ...rest] = block.trim().split("\n");
        const answers = [];
        let answerIndex = -1;
        rest.forEach((line, i) => {
          const trimmed = line.replace(/^[-*] /, "").trim();
          if (trimmed.startsWith("**") && trimmed.endsWith("**")) {
            answerIndex = i;
            answers.push(trimmed.slice(2, -2));
          } else {
            answers.push(trimmed);
          }
        });
        return {
          question: qLine.trim(),
          answers,
          answer: answerIndex
        };
      });
    }

    function saveProgress() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify([...usedIndexes]));
      localStorage.setItem(SCORE_KEY, score);
      localStorage.setItem(WRONG_KEY, JSON.stringify(wrongAnswers));
    }

    function loadProgress() {
      const saved = localStorage.getItem(STORAGE_KEY);
      const scoreSaved = localStorage.getItem(SCORE_KEY);
      const wrongSaved = localStorage.getItem(WRONG_KEY);
      if (saved) usedIndexes = new Set(JSON.parse(saved));
      if (scoreSaved) score = parseInt(scoreSaved);
      if (wrongSaved) wrongAnswers = JSON.parse(wrongSaved);
    }

    function showScore() {
      document.getElementById("scoreBox").innerText = `Pontua√ß√£o: ${score} / ${questions.length}`;
    }

    function showRandomQuestion() {
      answered = false;
      document.getElementById("feedback").innerText = "";
      const optionsList = document.getElementById("optionsList");
      optionsList.innerHTML = "";

      const box = document.getElementById("questionBox");
      const retryBtn = document.getElementById("retryBtn");
      const resetBtn = document.getElementById("resetBtn");
      if (retryBtn) retryBtn.remove();
      if (resetBtn) resetBtn.remove();

      if (usedIndexes.size === questions.length) {
        const retry = document.createElement("button");
        retry.id = "retryBtn";
        retry.innerText = "üîÅ Tentar novamente apenas as erradas";
        retry.onclick = () => {
          usedIndexes = new Set();
          score = 0;
          questions = [...wrongAnswers];
          wrongAnswers = [];
          showScore();
          showRandomQuestion();
        };

        const reset = document.createElement("button");
        reset.id = "resetBtn";
        reset.innerText = "üîÑ Recome√ßar todas";
        reset.onclick = () => {
          usedIndexes = new Set();
          wrongAnswers = [];
          score = 0;
          loadQuestions();
        };

        box.appendChild(retry);
        box.appendChild(reset);
        return;
      }

      let index;
      do {
        index = Math.floor(Math.random() * questions.length);
      } while (usedIndexes.has(index));

      currentQuestion = questions[index];
      usedIndexes.add(index);
      document.getElementById("questionText").innerText = currentQuestion.question;

      currentQuestion.answers.forEach((ans, i) => {
        const btn = document.createElement("button");
        btn.innerText = ans;
        btn.onclick = () => handleOptionClick(i);
        const li = document.createElement("li");
        li.appendChild(btn);
        optionsList.appendChild(li);
      });

      saveProgress();
    }

    function handleOptionClick(selectedIndex) {
      if (answered) return;
      answered = true;

      const optionsList = document.getElementById('optionsList');
      const buttons = optionsList.querySelectorAll('button');

      buttons.forEach((btn, idx) => {
        btn.disabled = true;
        if (idx === selectedIndex) {
          btn.classList.add('selected');
        }
        if (idx === currentQuestion.answer) {
          btn.style.backgroundColor = '#16a34a';
          btn.style.color = '#fff';
        } else if (idx === selectedIndex && selectedIndex !== currentQuestion.answer) {
          btn.style.backgroundColor = '#dc2626';
          btn.style.color = '#fff';
        }
      });

      const feedback = document.getElementById("feedback");
      if (selectedIndex === currentQuestion.answer) {
        feedback.innerText = "‚úÖ Correto!";
        score++;
      } else {
        feedback.innerText = "‚ùå Errado!";
        if (!wrongAnswers.some(q => q.question === currentQuestion.question)) {
          wrongAnswers.push(currentQuestion);
        }
      }

      showScore();
      saveProgress();
    }

    document.getElementById("nextButton").addEventListener("click", showRandomQuestion);

    document.getElementById("clearProgress").onclick = () => {
      if (confirm("Tem certeza de que deseja apagar todo o progresso?")) {
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(SCORE_KEY);
        localStorage.removeItem(WRONG_KEY);
        usedIndexes = new Set();
        score = 0;
        wrongAnswers = [];
        document.getElementById("nextButton").disabled = false;
        showScore();
        loadQuestions();
      }
    };

    loadProgress();
    loadQuestions();
  </script>
</body>
</html>
